import React, { useState, useEffect } from 'react';
import client from '../api/client';

function Dashboard() {
  const [prompt, setPrompt] = useState('');
  const [file, setFile] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [response, setResponse] = useState('');
  const [selectedModel] = useState('claude-3-5-sonnet-20241022');
  const [usedModel, setUsedModel] = useState('');
  const [events, setEvents] = useState({});
  const [currentMonth] = useState(new Date().getMonth() + 1);
  const [currentYear] = useState(new Date().getFullYear());

  // Fetch events from backend
  useEffect(() => {
    const fetchEvents = async () => {
      try {
        const res = await client.get('/schedules/');
        // Group events by date
        const eventsByDate = {};
        res.data.forEach(event => {
          const date = event.start_date;
          if (!eventsByDate[date]) {
            eventsByDate[date] = [];
          }
          eventsByDate[date].push(event);
        });
        setEvents(eventsByDate);
      } catch (error) {
        console.error("Failed to fetch events", error);
      }
    };
    fetchEvents();
  }, []);

  const handlePromptSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      let res;
      if (file) {
        const formData = new FormData();
        formData.append('file', file);
        if (prompt) formData.append('prompt', prompt);
        formData.append('ai_model', selectedModel);
        
        res = await client.post('/prompts/upload', formData, {
          headers: {
            'Content-Type': 'multipart/form-data',
          },
        });
        
        // If it's a student list upload, show success message and maybe redirect or refresh
        if (res.data.students) {
          setResponse(`í•™ìƒ ëª…ë¶€ ì¸ì‹ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ ${res.data.count}ëª…ì˜ í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n[ì¸ì‹ëœ í•™ìƒ ëª©ë¡]\n${res.data.students.map(s => `${s.number}ë²ˆ ${s.name}`).join(', ')}`);
          setUsedModel(selectedModel);
          setFile(null); // Reset file
          // Trigger a refresh of the layout sidebar status if possible, or just let user navigate
          // Ideally we would use a context or global state, but for now a reload or navigation will update it
          window.dispatchEvent(new Event('student-records-updated')); // Custom event if we want to listen
        } else {
           setResponse(res.data.generated_document || JSON.stringify(res.data, null, 2));
           setUsedModel(res.data.ai_model || selectedModel);
        }
      } else {
        res = await client.post('/prompts/', { 
          content: prompt,
          ai_model: selectedModel 
        });
        setResponse(res.data.generated_document);
        setUsedModel(res.data.ai_model);
      }
    } catch (error) {
      console.error("Failed to submit prompt", error);
      setResponse("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    } finally {
      setIsLoading(false);
    }
  };

  const getDaysInMonth = (month, year) => {
    return new Date(year, month, 0).getDate();
  };

  const daysInMonth = getDaysInMonth(currentMonth, currentYear);

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold text-gray-900">ì—…ë¬´ë„ìš°ë¯¸</h1>
      </div>
      
      {/* Quick Access Tabs */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* Calendar Tab */}
        <a 
          href="/schedule"
          className="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer"
        >
          <div className="px-4 py-5 sm:p-6">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <span className="text-4xl">ğŸ“…</span>
              </div>
              <div className="ml-5 w-0 flex-1">
                <dl>
                  <dt className="text-sm font-medium text-gray-500 truncate">
                    í•™ì‚¬ì¼ì •
                  </dt>
                  <dd className="text-lg font-medium text-gray-900">
                    {currentYear}ë…„ {currentMonth}ì›”
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </a>

        {/* Subject Evaluation Tab */}
        <a 
          href="/subject-evaluation"
          className="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer"
        >
          <div className="px-4 py-5 sm:p-6">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <span className="text-4xl">ğŸ“Š</span>
              </div>
              <div className="ml-5 w-0 flex-1">
                <dl>
                  <dt className="text-sm font-medium text-gray-500 truncate">
                    êµê³¼í‰ê°€
                  </dt>
                  <dd className="text-lg font-medium text-gray-900">
                    ì„±ì  ê´€ë¦¬
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </a>

        {/* Student Records Tab */}
        <a 
          href="/student-records"
          className="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer"
        >
          <div className="px-4 py-5 sm:p-6">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <span className="text-4xl">ğŸ‘¥</span>
              </div>
              <div className="ml-5 w-0 flex-1">
                <dl>
                  <dt className="text-sm font-medium text-gray-500 truncate">
                    í•™ìƒëª…ë¶€
                  </dt>
                  <dd className="text-lg font-medium text-gray-900">
                    {events && Object.keys(events).length > 0 ? 'ëª…ë‹¨ ë“±ë¡ë¨' : 'ëª…ë‹¨ ê´€ë¦¬'}
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </a>
      </div>
      
      {/* AI Prompt Section - Full Width */}
      <div className="bg-white overflow-hidden shadow rounded-lg">
        <div className="px-4 py-5 sm:p-6">
          <h2 className="text-lg font-medium leading-6 text-gray-900 mb-4">í•™êµ ì—…ë¬´ì™€ ê´€ë ¨ëœ ëª¨ë“  ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”.</h2>
          
          {/* Quick Suggestion Buttons */}
          <div className="flex flex-wrap gap-3 mb-6">
            <button
              type="button"
              onClick={() => setPrompt('í•™ì‚¬ì¼ì •ì— ëŒ€í•´ ì•Œë ¤ì¤˜')}
              className="inline-flex items-center px-4 py-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 transition-colors text-sm font-medium text-gray-700"
            >
              <span className="mr-2 text-lg">ğŸ“…</span>
              í•™ì‚¬ì¼ì •
            </button>
            <button
              type="button"
              onClick={() => setPrompt('ìƒí™œê¸°ë¡ë¶€ ì‘ì„±ì„ ë„ì™€ì¤˜')}
              className="inline-flex items-center px-4 py-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 transition-colors text-sm font-medium text-gray-700"
            >
              <span className="mr-2 text-lg">ğŸ“</span>
              ìƒí™œê¸°ë¡ë¶€
            </button>
            <button
              type="button"
              onClick={() => setPrompt('NEIS ì—…ë¬´ë¥¼ ë„ì™€ì¤˜')}
              className="inline-flex items-center px-4 py-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 transition-colors text-sm font-medium text-gray-700"
            >
              <span className="mr-2 text-lg">ğŸ’¼</span>
              NEIS ì—…ë¬´
            </button>
          </div>
          

          <>
            <form onSubmit={handlePromptSubmit}>
              <div className="mb-2">
                <label htmlFor="prompt" className="sr-only">Prompt</label>
                <div className="relative">
                  <textarea
                    id="prompt"
                    className="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md p-3 pb-10"
                    rows={12}
                    placeholder="ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 'í˜„ì¥í•™ìŠµ ì•ˆë‚´ë¬¸ ì‘ì„±í•´ì¤˜'). í•™ìƒ ëª…ë¶€ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤."
                    value={prompt}
                    onChange={(e) => setPrompt(e.target.value)}
                  />
                  <div className="absolute bottom-2 left-2">
                      <input
                        type="file"
                        id="file-upload"
                        className="hidden"
                        accept="image/*"
                        onChange={(e) => setFile(e.target.files[0])}
                      />
                      <label
                        htmlFor="file-upload"
                        className={`cursor-pointer inline-flex items-center p-1.5 rounded-full hover:bg-gray-100 transition-colors ${file ? 'text-primary-600 bg-primary-50' : 'text-gray-400'}`}
                        title="ì´ë¯¸ì§€ ì—…ë¡œë“œ"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                          <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                        </svg>
                        {file && <span className="ml-1 text-xs font-medium">{file.name}</span>}
                      </label>
                    </div>
                  </div>
                <div className="flex justify-end">
                  <button 
                    type="submit" 
                    disabled={isLoading}
                    className={`inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white ${isLoading ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700'} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500`}
                  >
                    {isLoading ? 'ìƒì„± ì¤‘...' : 'ìƒì„±í•˜ê¸°'}
                  </button>
                </div>
              </div>
            </form>
            {response && (
              <div className="mt-6 bg-gray-50 rounded-md p-4 border border-gray-200">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="text-sm font-medium text-gray-900">ê²°ê³¼:</h3>
                  {usedModel && (
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      usedModel.startsWith('claude') ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'
                    }`}>
                      {usedModel.startsWith('claude') ? 'ğŸ¤– Claude' : 
                       usedModel === 'gpt-4o-mini' ? 'âš¡ GPT-4o Mini' : 'ğŸ§  GPT-4o'}
                    </span>
                  )}
                </div>
                <pre className="whitespace-pre-wrap text-sm text-gray-700 font-mono bg-white p-3 rounded border border-gray-200">{response}</pre>
              </div>
            )}
          </>
        </div>
        </div>
      </div>
    </div>
  );
}

export default Dashboard;
